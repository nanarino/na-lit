---
import parse from "style-to-object"
import dedent from "dedent"

interface Props {
    class?: string
}

const props = Astro.props

let code: string = ""
if (Astro.slots.has("default")) {
    code = await Astro.slots.render("default") // astro:components
    // pre[style]
    code = code.replace(
        /<pre .*?>/,
        `<pre class="na-pre ${props.class ?? ""}">`
    )
    // pre > code
    code = code.replace("<code>", '<code class="na-code">')
    // pre > code > .line > span[style]
    code = code.replace(/<span style="(.*?)">/gim, (span, cssText?: string) => {
        if (cssText?.includes("--shiki-dark:")) {
            const style = parse(cssText)
            return dedent`<span style="
                --color-code: from ${style.color} r g b;
                --color-code-dark: from ${style["--shiki-dark"]} r g b;
            ">`
        }
        return span
    })
}
---

<Fragment set:html={code} />
